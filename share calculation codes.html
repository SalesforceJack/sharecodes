<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ortaklık Modelleri karsilastirmasi </title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Lato', sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background-color: #f4f4f9; 
            padding: 20px 15px; 
            margin: 0;
            color: #333;
        }
        h1 { margin: 0 0 15px; color: #0d47a1; }
        h2, h3, h4 { color: #1565c0; margin-top: 20px; border-bottom: 2px solid #e3f2fd; padding-bottom: 5px; }
        
        .calculator-wrapper {
            background-color: white; 
            padding: 30px; 
            box-shadow: 0 4px 10px rgba(0,0,0,.1); 
            width: 100%;
            max-width: 1700px;
            border-radius: 8px;
        }
        
        .input-area {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-group {
            flex: 1 1 200px; 
        }
        .input-group label { 
            display: block; 
            font-weight: bold; 
            margin-bottom: 5px;
        }
        .input-group input {
            border: 1px solid #ddd; 
            border-radius: 5px; 
            width: 100%; 
            padding: 11px; 
            font-size: 1em; 
        }

        .button-wrapper { 
            text-align: center; 
            margin-top: 20px;
        }
        button { 
            border: none; 
            background-color: #4CAF50; 
            padding: 12px 20px; 
            color: white; 
            font-weight: 700; 
            text-transform: uppercase; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            width: 100%;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { background-color: #388E3C; }

        .comparison-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .scenario-box {
            flex: 1 1 30%;
            min-width: 480px; 
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #eee;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .results-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
            font-size: 0.75em;
        }
        .results-table th, .results-table td { 
            border: 1px solid #e0e0e0; 
            padding: 6px;
            text-align: right; 
        }
        .results-table th { 
            background-color: #e3f2fd; 
            color: #1565c0; 
            text-align: center; 
            font-weight: bold; 
        }
        .results-table tfoot td { 
            font-weight: bold; 
            background-color: #bbdefb; 
            color: #0d47a1; 
            font-size: 1em; 
        }
        .net-cash-flow { 
            background-color: #e8f5e9; 
            font-weight: bold; 
            color: #1B5E20; 
        }
        .loan { 
            color: #d32f2f; 
        }
        .summary-box {
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .summary-box.s2 { background-color: #c8e6c9; border: 1px solid #4CAF50; }
        .summary-box.s1, .summary-box.s3 { background-color: #fbecec; border: 1px solid #f08080; }
        
        .percentage-diff {
            font-weight: bold;
            color: #7B1FA2; /* Mor renk farkı belirtir */
        }

    </style>
</head>
<body>
    <main class="calculator-wrapper">
        <header>
            <h1>Ortaklık Modeli Karsilastirmalari</h1>
        </header>

        <div class="input-area">
            <div class="input-group">
                <label for="dukkanEBITDA">Yıllık EBIDTA ($):</label>
                <input type="text" id="dukkanEBITDA" value="200000">
            </div>
            <div class="input-group">
                <label for="loanAmount">Toplam Kredi Tutarı ($):</label>
                <input type="text" id="loanAmount" value="500000">
            </div>
            <div class="input-group">
                <label for="loanTermMonths">Kredi Süresi (Ay) :</label>
                <input type="number" id="loanTermMonths" value="84" min="12">
            </div>
            <div class="input-group">
                <label for="annualGrowthRate">Yıllık EBITDA Artis Oranı (%) (Örn: 5):</label>
                <input type="number" id="annualGrowthRate" value="5" min="0" step="0.5">
            </div>
        </div>
        
        <div class="button-wrapper">
            <button onclick="calculateAllScenarios()">TÜM SENARYOLARI HESAPLA ve KARŞILAŞTIR</button>
        </div>
        
        <div id="error-message"></div>
        <hr style="border-top: 1px solid #eee; margin: 30px 0;">
        
        <div class="comparison-container" id="results">
            </div>

    </main>
    
<script>

// --- Yardımcı Fonksiyonlar ---

function calculateMonthlyPayment(principal, annualRate, months) {
    const monthlyRate = annualRate / 12 / 100;
    const numberOfPayments = months;

    if (monthlyRate === 0 || numberOfPayments === 0) {
        return principal / months; 
    }

    const monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) / (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
    return monthlyPayment;
}

function formatNumber(number) {
    if (isNaN(number) || !isFinite(number)) return '0.00';
    return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getAmortizationSchedule(totalLoanPrincipal, loanTermMonths, APR) {
    const monthlyLoanPayment = calculateMonthlyPayment(totalLoanPrincipal, APR, loanTermMonths);
    let loanBalance = totalLoanPrincipal;
    let amortizationSchedule = {};

    for (let month = 1; month <= loanTermMonths; month++) {
        if (loanBalance <= 0) break;

        const monthlyRate = APR / 12 / 100;
        const interestPayment = loanBalance * monthlyRate;
        let principalPayment = monthlyLoanPayment - interestPayment;
        let payment = monthlyLoanPayment;

        if (principalPayment > loanBalance) {
            principalPayment = loanBalance;
            payment = interestPayment + principalPayment;
            loanBalance = 0;
        } else {
             loanBalance = loanBalance - principalPayment;
        }
        
        const year = Math.ceil(month / 12); 

        if (!amortizationSchedule[year]) {
            amortizationSchedule[year] = { year: year, totalPayment: 0, endingBalance: 0 };
        }
        
        amortizationSchedule[year].totalPayment += payment;
        amortizationSchedule[year].endingBalance = loanBalance;
    }
    return amortizationSchedule;
}

// --- Ana Hesaplama Fonksiyonu ---

function calculateAllScenarios() {
    
    // 1. Girdi Değerlerini Al ve Kontrol Et
    const dukkanEBITDAValue = document.getElementById('dukkanEBITDA').value.replace(/,/g, '');
    const loanAmountValue = document.getElementById('loanAmount').value.replace(/,/g, '');
    
    const initialAnnualNetProfit = parseFloat(dukkanEBITDAValue); 
    const totalLoanPrincipal = parseFloat(loanAmountValue);
    const loanTermMonths = parseInt(document.getElementById('loanTermMonths').value); 
    const annualGrowthRate = parseFloat(document.getElementById('annualGrowthRate').value) / 100;
    
    const NUM_YEARS_OF_ANALYSIS = Math.ceil(loanTermMonths / 12); 
    const APR = 10; 
    const EXIT_MULTIPLIER = 3; 

    // Basit Kontrol
    if (isNaN(initialAnnualNetProfit) || initialAnnualNetProfit <= 0 || isNaN(totalLoanPrincipal) || totalLoanPrincipal < 0 || isNaN(loanTermMonths) || loanTermMonths <= 0 || isNaN(annualGrowthRate)) {
        document.getElementById('error-message').innerHTML = '<p class="error">Lütfen tüm alanlara geçerli değerler girin (sayı formatında).</p>';
        document.getElementById('results').innerHTML = '';
        return;
    }
    document.getElementById('error-message').innerHTML = '';

    // KURAL SABİTLERİ
    const P1_OWNERSHIP = 0.50; 
    const INVESTOR_OWNERSHIP = 0.50; 
    
    const P1_PROFIT_SHARE = 2 / 3; 
    const INVESTOR_PROFIT_SHARE = 1 / 3; 

    const amortizationSchedule = getAmortizationSchedule(totalLoanPrincipal, loanTermMonths, APR);

    // --- SENARYO 1: Mülkiyet Payına Dayalı (%50 İşleten / %50 Yatırımcı) ---
    const s1Result = calculateScenario(initialAnnualNetProfit, NUM_YEARS_OF_ANALYSIS, annualGrowthRate, amortizationSchedule, EXIT_MULTIPLIER, P1_PROFIT_SHARE, INVESTOR_PROFIT_SHARE, P1_OWNERSHIP, INVESTOR_OWNERSHIP, "ownership");
    
    // --- SENARYO 2: Kredi once odenir sonra Kâr  paylastirilir.---
    const s2Result = calculateScenario(initialAnnualNetProfit, NUM_YEARS_OF_ANALYSIS, annualGrowthRate, amortizationSchedule, EXIT_MULTIPLIER, P1_PROFIT_SHARE, INVESTOR_PROFIT_SHARE, P1_OWNERSHIP, INVESTOR_OWNERSHIP, "company");

    // --- SENARYO 3: Kâr Payı Oranına Gore kredi odemesi ustlenilir (%67 İşleten / %33 Yatırımcı) ---
    const s3Result = calculateScenario(initialAnnualNetProfit, NUM_YEARS_OF_ANALYSIS, annualGrowthRate, amortizationSchedule, EXIT_MULTIPLIER, P1_PROFIT_SHARE, INVESTOR_PROFIT_SHARE, P1_OWNERSHIP, INVESTOR_OWNERSHIP, "profit_share");

    // 3. Sonuçları HTML'e Yazdır (İstenen Sıralama: S1, S2, S3)
    let comparisonHTML = `
        <div class="scenario-box">` + generateHTMLOutput(s1Result, "1. SENARYO: Kredi Mülkiyet Oranına Düşülür", "s1", NUM_YEARS_OF_ANALYSIS) + `</div>
        <div class="scenario-box">` + generateHTMLOutput(s2Result, "2. SENARYO: Kredi Once  Odenir, kar sonra paylastirilir  ", "s2", NUM_YEARS_OF_ANALYSIS) + `</div>
        <div class="scenario-box">` + generateHTMLOutput(s3Result, "3. SENARYO: Kredi Kâr Payı Oranına Düşülür", "s3", NUM_YEARS_OF_ANALYSIS) + `</div>
    `;

    document.getElementById('results').innerHTML = comparisonHTML;
}

// --- GENEL HESAPLAYICI (Tüm Senaryoları Kapsar) ---
function calculateScenario(initialProfit, numYears, growthRate, amortization, exitMultiplier, p1Share, invShare, p1Own, invOwn, loanDeductionType) {
    let currentAnnualNetProfit = initialProfit;
    let finalYearEBITDA = 0;
    let annualDetails = [];
    let cumulativeP1Net = 0;
    let cumulativeInvNet = 0;
    
    // Kredi Sorumluluğu Oranları
    let P1_DEDUCTION_RATE = 0;
    let INV_DEDUCTION_RATE = 0;

    if (loanDeductionType === "ownership") {
        P1_DEDUCTION_RATE = p1Own; // %50
        INV_DEDUCTION_RATE = invOwn; // %50
    } else if (loanDeductionType === "profit_share") {
        P1_DEDUCTION_RATE = p1Share; // 2/3
        INV_DEDUCTION_RATE = invShare; // 1/3
    }

    for (let year = 1; year <= numYears; year++) {
        if (year > 1) { currentAnnualNetProfit *= (1 + growthRate); }
        if (year === numYears) { finalYearEBITDA = currentAnnualNetProfit; }
        
        let totalYearlyLoanPayment = amortization[year] ? amortization[year].totalPayment : 0;
        
        let P1_ANNUAL_PROFIT_BRUT = 0;
        let INV_ANNUAL_PROFIT_BRUT = 0;
        let P1_LOAN_SHARE = 0;
        let INV_LOAN_SHARE = 0;
        let P1_NET_CASH = 0;
        let INV_NET_CASH = 0;
        let COMPANY_LOAN_DEDUCTION = 0; 

        if (loanDeductionType === "company") {
            COMPANY_LOAN_DEDUCTION = totalYearlyLoanPayment;
            const remainingCashFlow = currentAnnualNetProfit - COMPANY_LOAN_DEDUCTION;
            
            P1_ANNUAL_PROFIT_BRUT = currentAnnualNetProfit * p1Share;
            INV_ANNUAL_PROFIT_BRUT = currentAnnualNetProfit * invShare;

            if (remainingCashFlow > 0) {
                P1_NET_CASH = remainingCashFlow * p1Share;
                INV_NET_CASH = remainingCashFlow * invShare;
            } else {
                P1_NET_CASH = 0;
                INV_NET_CASH = 0;
            }
            P1_LOAN_SHARE = 0; 
            INV_LOAN_SHARE = 0; 
            
        } else {
            P1_ANNUAL_PROFIT_BRUT = currentAnnualNetProfit * p1Share;
            INV_ANNUAL_PROFIT_BRUT = currentAnnualNetProfit * invShare;
            
            P1_LOAN_SHARE = totalYearlyLoanPayment * P1_DEDUCTION_RATE;
            INV_LOAN_SHARE = totalYearlyLoanPayment * INV_DEDUCTION_RATE; 

            P1_NET_CASH = P1_ANNUAL_PROFIT_BRUT - P1_LOAN_SHARE;
            INV_NET_CASH = INV_ANNUAL_PROFIT_BRUT - INV_LOAN_SHARE;

            COMPANY_LOAN_DEDUCTION = 0; 
        }

        cumulativeP1Net += P1_NET_CASH;
        cumulativeInvNet += INV_NET_CASH;

        annualDetails.push({ year, P1_NET_CASH, INV_NET_CASH, P1_ANNUAL_PROFIT: P1_ANNUAL_PROFIT_BRUT, INV_ANNUAL_PROFIT: INV_ANNUAL_PROFIT_BRUT, P1_LOAN_SHARE, INV_LOAN_SHARE, COMPANY_LOAN_DEDUCTION, currentAnnualNetProfit, totalYearlyLoanPayment, loanDeductionType });
    }
    
    // Satış Hesaplaması (Tüm senaryolarda aynıdır)
    const finalLoanBalance = amortization[numYears] ? amortization[numYears].endingBalance : 0;
    const saleValue = finalYearEBITDA * exitMultiplier;
    const netSaleProceeds = saleValue - finalLoanBalance; 

    const P1_SALE_PROCEEDS = netSaleProceeds * p1Own;
    const INV_SALE_PROCEEDS = netSaleProceeds * invOwn;

    const P1_GRAND_TOTAL = cumulativeP1Net + P1_SALE_PROCEEDS;
    const INV_GRAND_TOTAL = cumulativeInvNet + INV_SALE_PROCEEDS;
    const GRAND_TOTAL = P1_GRAND_TOTAL + INV_GRAND_TOTAL;
    
    // Sonuçları döndür
    return {
        P1_GRAND_TOTAL, INV_GRAND_TOTAL, GRAND_TOTAL, finalYearEBITDA, finalLoanBalance, saleValue, netSaleProceeds,
        P1_SALE_PROCEEDS, INV_SALE_PROCEEDS, cumulativeP1Net, cumulativeInvNet, p1Share, invShare, p1Own, invOwn, annualDetails, loanDeductionType
    };
}


// --- HTML OLUŞTURUCU FONKSİYONU ---
function generateHTMLOutput(result, title, scenarioClass, numYears) {
    
    // Yüzdelik hesaplamaları
    const P1_TOTAL_SHARE_PERCENT = result.GRAND_TOTAL > 0 ? (result.P1_GRAND_TOTAL / result.GRAND_TOTAL) * 100 : 0;
    const INVESTOR_TOTAL_SHARE_PERCENT = 100 - P1_TOTAL_SHARE_PERCENT;
    const PERCENTAGE_DIFFERENCE = P1_TOTAL_SHARE_PERCENT - INVESTOR_TOTAL_SHARE_PERCENT;
    
    // Nakit farkı
    const P1_CASH_DIFF = result.cumulativeP1Net - result.cumulativeInvNet;
    
    // Dinamik Başlık ve Sütun Yapısı
    let headerRow = '';
    let bodyRows = '';
    
    if (result.loanDeductionType === "company") {
        // Senaryo 2: Şirket Kredisi Sütunu Eklendi
        headerRow = `
            <tr>
                <th>Yıl</th>
                <th>Toplam Kâr</th>
                <th class="loan">Dağıtım Öncesi Kredi Düşüşü</th>
                <th>İşleten Brüt Kâr</th>
                <th class="net-cash-flow">İşleten Net Kazanç</th>
                <th>Yatr. Brüt Kâr</th>
                <th class="net-cash-flow">Yatr. Net Kazanç</th>
            </tr>
        `;
        result.annualDetails.forEach(d => {
            bodyRows += `
                <tr>
                    <td>${d.year}.</td>
                    <td>${formatNumber(d.currentAnnualNetProfit)}</td>
                    <td class="loan">(${formatNumber(d.COMPANY_LOAN_DEDUCTION)})</td>
                    <td>${formatNumber(d.P1_ANNUAL_PROFIT)}</td>
                    <td class="net-cash-flow">${formatNumber(d.P1_NET_CASH)}</td>
                    <td>${formatNumber(d.INV_ANNUAL_PROFIT)}</td>
                    <td class="net-cash-flow">${formatNumber(d.INV_NET_CASH)}</td>
                </tr>
            `;
        });
    } else {
        // Senaryo 1 ve 3: Ortakların Kredi Düşüşü Sütunları
        headerRow = `
            <tr>
                <th>Yıl</th>
                <th>Toplam Kâr</th>
                <th>İşleten Brüt Kâr</th>
                <th class="loan">İşleten Kredi Düşüşü</th>
                <th class="net-cash-flow">İşleten Net Kazanç</th>
                <th>Yatr. Brüt Kâr</th>
                <th class="loan">Yatr. Kredi Düşüşü</th>
                <th class="net-cash-flow">Yatr. Net Kazanç</th>
            </tr>
        `;
        result.annualDetails.forEach(d => {
            bodyRows += `
                <tr>
                    <td>${d.year}.</td>
                    <td>${formatNumber(d.currentAnnualNetProfit)}</td>
                    <td>${formatNumber(d.P1_ANNUAL_PROFIT)}</td>
                    <td class="loan">(${formatNumber(d.P1_LOAN_SHARE)})</td>
                    <td class="net-cash-flow">${formatNumber(d.P1_NET_CASH)}</td>
                    <td>${formatNumber(d.INV_ANNUAL_PROFIT)}</td>
                    <td class="loan">(${formatNumber(d.INV_LOAN_SHARE)})</td>
                    <td class="net-cash-flow">${formatNumber(d.INV_NET_CASH)}</td>
                </tr>
            `;
        });
    }


    let annualTableHTML = `
        <h4 style="color: #6a1b9a;">Yıllık Nakit Akışı Detayı (İşleten Kâr Payı: %${Math.round(result.p1Share*100)})</h4>
        <table class="results-table">
            <thead>${headerRow}</thead>
            <tbody>${bodyRows}</tbody>
        </table>
    `;


    let html = `
        <h3>${title}</h3>
        ${annualTableHTML}
        
        <h4 style="color: #6a1b9a;">${numYears} Yıl Sonu Sonuçları</h4>
        <table class="results-table">
            <tfoot>
                 <tr>
                    <td>**İşleten Toplam Net Kazanç**</td>
                    <td colspan="3" class="net-cash-flow">${formatNumber(result.cumulativeP1Net)}</td>
                    <td>**Yatr. Toplam Net Kazanç**</td>
                    <td colspan="3" class="net-cash-flow">${formatNumber(result.cumulativeInvNet)}</td>
                </tr>
                 <tr>
                    <td>**İşleten Toplam Kazanç (Net Kâr + Satış)**</td>
                    <td colspan="3" class="net-cash-flow">${formatNumber(result.P1_GRAND_TOTAL)}</td>
                    <td>**Yatr. Toplam Kazanç (Net Kâr + Satış)**</td>
                    <td colspan="3" class="net-cash-flow">${formatNumber(result.INV_GRAND_TOTAL)}</td>
                </tr>
            </tfoot>
        </table>
        
        <div class="summary-box ${scenarioClass}">
            <h4>Toplam Kazanç Payları (%)</h4>
            <p>
                **İşleten Payı:** <strong style="color: #0d47a1;">%${P1_TOTAL_SHARE_PERCENT.toFixed(1)}</strong> | 
                **Yatırımcı Payı:** <strong style="color: #0d47a1;">%${INVESTOR_TOTAL_SHARE_PERCENT.toFixed(1)}</strong>
            </p>
            <p>
                **Yüzdelik Fark (İşleten - Yatr.):** <span class="percentage-diff">${PERCENTAGE_DIFFERENCE.toFixed(1)}%</span>
            </p>
            <p>
                **Net Kazanç Farkı (İşleten - Yatr.):** <strong style="color: #1B5E20;">${formatNumber(P1_CASH_DIFF)}</strong>
            </p>
        </div>
    `;
    return html;
}

</script>
</body>
</html>

